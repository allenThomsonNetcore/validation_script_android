<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Validation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e35502;
            --header-bg: #230f2e;
        }
        
        .container { margin-top: 30px; }
        .table-container { margin-top: 20px; }
        .filter-container { margin: 20px 0; }
        .hidden { display: none; }
        .first-event { color: blue; }
        
        /* Header styling */
        .navbar {
            background-color: var(--header-bg) !important;
        }
        
        .navbar-brand, .navbar-nav .nav-link {
            color: white !important;
        }
        
        .navbar-toggler {
            border-color: rgba(255,255,255,0.5);
        }
        
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }
        
        /* Button styling */
        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        
        .btn-primary:hover {
            background-color: #c64802 !important;
            border-color: #c64802 !important;
        }
        
        .btn-outline-primary {
            color: white !important;
            border-color: white !important;
        }
        
        .btn-outline-primary:hover {
            background-color: rgba(255,255,255,0.1) !important;
        }
        .null-value { background-color: yellow; }
        .valid-status { color: green; }
        .invalid-status { color: red; }
        .empty-status { color: orange; }
        .not-present { color: darkolivegreen; }
        .extra-key { color: rgb(24, 214, 185); }
        .type-mismatch { background-color: #ffe6e6; }
        .download-section {
            margin: 20px 0;
            text-align: right;
        }
        /* Status color coding */
        .status-valid { background-color: #d4edda !important; color: #155724 !important; }
        .status-invalid { background-color: #f8d7da !important; color: #721c24 !important; }
        .status-empty { background-color: #fff3cd !important; color: #856404 !important; }
        .status-extra { background-color: #d1ecf1 !important; color: #0c5460 !important; }
        .status-notpresent { background-color: #042508 !important; color: #7f7b97 !important; }
        .status-csv { background-color: #e2e3e5 !important; color: #383d41 !important; }
        .status-extra-event { background-color: #f8d7da !important; color: #721c24 !important; }
        .status-extra-field { background-color: #fff3cd !important; color: #856404 !important; }
        .validation-status {
            font-weight: bold;
        }
        .status-valid {
            color: #28a745;
        }
        .status-invalid {
            color: #dc3545;
        }
        .status-empty {
            color: #ffc107;
        }
        .status-extra {
            color: #17a2b8;
        }
        .status-extra-event {
            color: #dc3545;
        }
        .status-extra-field {
            color: #ffc107;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .sort-header {
            cursor: pointer;
        }
        .sort-header:hover {
            background-color: #e9ecef;
        }
        .sort-icon {
            margin-left: 5px;
        }
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 10px;
        }
        .filter-content.show {
            display: block;
        }
        .filter-checkbox {
            margin: 5px 0;
        }
        .filter-checkbox label {
            display: block;
            padding: 5px;
            cursor: pointer;
        }
        .filter-checkbox label:hover {
            background-color: #f1f1f1;
        }
        .filter-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
        }
        .filter-header:hover {
            background-color: #f1f1f1;
        }
        .filter-icon {
            margin-left: 5px;
        }
        .filter-actions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Netcore Event Payload Validator</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="btn btn-primary" href="https://contact-api-via-csv-7e94e.web.app/" target="_blank">Trigger Activity API</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Event Validation Tool</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Validation Mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="validationMode" id="regularMode" value="regular" checked>
                        <label class="form-check-label" for="regularMode">
                            Android and iOS Event (Single Event/Event Payload format)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="validationMode" id="websiteMode" value="website">
                        <label class="form-check-label" for="websiteMode">
                            Website Logs Validation (JSON lines format with eventname and payload)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="validationMode" id="websiteV2Mode" value="website-v2">
                        <label class="form-check-label" for="websiteV2Mode">
                            Website Logs V2 Validation (JSON lines format with event key and system fields excluded)
                        </label>
                    </div>
                </div>
                
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV File (Validation Rules)</label>
                        <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                        <div class="mt-2">
                            <a href="/download_template" class="btn btn-outline-secondary btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Download Sample Template
                            </a>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="txtFile" class="form-label">TXT File (Event Logs)</label>
                        <input type="file" class="form-control" id="txtFile" name="txt_file" accept=".txt" required>
                        <div class="mt-2 sample-downloads">
                            <!-- Regular mode sample -->
                            <button class="btn btn-outline-secondary btn-sm sample-download regular-mode download-btn" data-mode="regular">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Download Regular Sample Log
                            </button>
                            <!-- Website mode sample -->
                            <button class="btn btn-outline-secondary btn-sm sample-download website-mode download-btn" data-mode="website" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                                Download Website Sample Log
                            </button>
                            <!-- Website V2 mode samples -->
                            <div class="v2-mode-downloads" style="display: none;">
                                <button class="btn btn-outline-secondary btn-sm mb-1 download-btn" data-mode="website-v2" data-multiline="false">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                    </svg>
                                    Download Website V2 Sample Log
                                </button>
                                <br>
                                <button class="btn btn-outline-secondary btn-sm download-btn" data-mode="website-v2" data-multiline="true">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                    </svg>
                                    Download Website V2 Multiline Sample
                                </button>
                            </div>
                            <div id="downloadError" class="alert alert-danger mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Validate</button>
                </form>
            </div>
        </div>

        <div class="filter-section" id="filterSection" style="display: none;">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Event Summary</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p class="mb-1"><strong>CSV Events:</strong></p>
                                    <p class="text-primary" id="csvEventsCount">0</p>
                                </div>
                                <div class="col-6">
                                    <p class="mb-1"><strong>Log Events:</strong></p>
                                    <p class="text-success" id="logEventsCount">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Event Details</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p class="mb-1"><strong>Missing Events:</strong></p>
                                    <p class="text-warning" id="missingEventsCount">0</p>
                                </div>
                                <div class="col-6">
                                    <p class="mb-1"><strong>Extra Events:</strong></p>
                                    <p class="text-info" id="extraEventsCount">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h4>Filters</h4>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="filter-dropdown">
                        <div class="filter-header" data-filter="eventName">
                            Event Name <span class="filter-icon">▼</span>
                        </div>
                        <div class="filter-content" id="eventNameFilter">
                            <div class="filter-checkbox">
                                <input type="checkbox" id="eventNameSelectAll" checked>
                                <label for="eventNameSelectAll">Select All</label>
                            </div>
                            <div id="eventNameOptions"></div>
                            <div class="filter-actions">
                                <button class="btn btn-sm btn-primary" onclick="applyFilter('eventName')">Apply</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearFilter('eventName')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="filter-dropdown">
                        <div class="filter-header" data-filter="status">
                            Status <span class="filter-icon">▼</span>
                        </div>
                        <div class="filter-content" id="statusFilter">
                            <div class="filter-checkbox">
                                <input type="checkbox" id="statusSelectAll" checked>
                                <label for="statusSelectAll">Select All</label>
                            </div>
                            <div id="statusOptions"></div>
                            <div class="filter-actions">
                                <button class="btn btn-sm btn-primary" onclick="applyFilter('status')">Apply</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearFilter('status')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="filter-dropdown">
                        <div class="filter-header" data-filter="expectedType">
                            Expected Type <span class="filter-icon">▼</span>
                        </div>
                        <div class="filter-content" id="expectedTypeFilter">
                            <div class="filter-checkbox">
                                <input type="checkbox" id="expectedTypeSelectAll" checked>
                                <label for="expectedTypeSelectAll">Select All</label>
                            </div>
                            <div id="expectedTypeOptions"></div>
                            <div class="filter-actions">
                                <button class="btn btn-sm btn-primary" onclick="applyFilter('expectedType')">Apply</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearFilter('expectedType')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="filter-dropdown">
                        <div class="filter-header" data-filter="receivedType">
                            Received Type <span class="filter-icon">▼</span>
                        </div>
                        <div class="filter-content" id="receivedTypeFilter">
                            <div class="filter-checkbox">
                                <input type="checkbox" id="receivedTypeSelectAll" checked>
                                <label for="receivedTypeSelectAll">Select All</label>
                            </div>
                            <div id="receivedTypeOptions"></div>
                            <div class="filter-actions">
                                <button class="btn btn-sm btn-primary" onclick="applyFilter('receivedType')">Apply</button>
                                <button class="btn btn-sm btn-secondary" onclick="clearFilter('receivedType')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-secondary" id="clearFilters">Clear All Filters</button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-success" id="downloadResults">Download Results</button>
                </div>
                <div class="col-md-4 mb-3">
                    <button class="btn btn-info" id="downloadValidEvents">Download Valid Events</button>
                </div>
            </div>
        </div>

        <div id="fullyValidEventsSection" class="alert alert-success" style="display:none;">
            <strong>Events with all payloads valid:</strong>
            <ul id="fullyValidEventsList" style="margin-bottom:0;"></ul>
        </div>

        <div class="table-container">
            <table class="table table-striped" id="resultsTable">
                <thead>
                    <tr>
                        <th class="sort-header" data-sort="eventName">Event Name <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="key">Key <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="value">Value <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="expectedType">Expected Type <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="receivedType">Received Type <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="validationStatus">Status <span class="sort-icon">↕</span></th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        let currentResults = [];
        let currentSummary = {};
        let currentSort = { field: null, order: 'asc' };
        let activeFilters = {
            eventName: [],
            status: [],
            expectedType: [],
            receivedType: []
        };

        $('#dateRange').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });

        $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            applyFilters();
        });

        $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
            applyFilters();
        });

        // Handle validation mode changes
        $('input[name="validationMode"]').change(function() {
            const mode = $(this).val();
            // Hide all sample download buttons first
            $('.sample-download, .v2-mode-downloads').hide();
            
            // Show the appropriate download button based on mode
            if (mode === 'regular') {
                $('.sample-download.regular-mode').show();
            } else if (mode === 'website') {
                $('.sample-download.website-mode').show();
            } else if (mode === 'website-v2') {
                $('.v2-mode-downloads').show();
            }
        });

        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Determine which endpoint to use based on validation mode
            const validationMode = $('input[name="validationMode"]:checked').val();
            let endpoint = '/upload';
            if (validationMode === 'website') {
                endpoint = '/validate-website-logs';
            } else if (validationMode === 'website-v2') {
                endpoint = '/validate-website-logs-v2';
            }
            
            // Get the current domain to ensure we're hitting the right server
            const baseUrl = window.location.origin;
            const fullUrl = baseUrl + endpoint;
            
            console.log('Making request to:', fullUrl);
            console.log('Validation mode:', validationMode);
            
            $.ajax({
                url: fullUrl,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Upload response:', response);
                    
                    // Ensure response is properly initialized
                    currentResults = [];
                    currentSummary = {
                        csv_events_count: 0,
                        log_events_count: 0,
                        csv_events: [],
                        log_events: []
                    };
                    window.originalLogs = {};
                    
                    // Handle both old and new response formats
                    if (response && response.results && Array.isArray(response.results)) {
                        // New format with summary
                        currentResults = response.results;
                        if (response.summary) {
                            currentSummary = response.summary;
                        }
                        if (response.original_logs) {
                            window.originalLogs = response.original_logs;
                        }
                    } else if (Array.isArray(response)) {
                        // Old format - just results array
                        currentResults = response;
                    } else {
                        console.error('Invalid response format:', response);
                    }
                    
                    updateEventSummary();
                    updateFilters();
                    displayResults(currentResults);
                    $('#filterSection').show();

                    if (response.fully_valid_events && response.fully_valid_events.length > 0) {
                        $('#fullyValidEventsList').empty();
                        response.fully_valid_events.forEach(function(eventName) {
                            $('#fullyValidEventsList').append('<li>' + eventName + '</li>');
                        });
                        $('#fullyValidEventsSection').show();
                    } else {
                        $('#fullyValidEventsSection').hide();
                    }
                },
                error: function(xhr) {
                    console.error('Upload error:', xhr);
                    alert('Error uploading files: ' + xhr.responseText);
                }
            });
        });

        // Initialize filter dropdowns
        // Handle sample file downloads
        $('.download-btn').click(function() {
            const mode = $(this).data('mode');
            const multiline = $(this).data('multiline') || false;
            let url = `/download_sample_log/${mode}`;
            if (mode === 'website-v2' && multiline) {
                url += '?multiline=true';
            }

            // Show loading state
            $(this).prop('disabled', true);
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Downloading...');
            const button = $(this);

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    let filename = 'sample_log.txt';
                    if (mode === 'website') {
                        filename = 'sample_website_logs.txt';
                    } else if (mode === 'website-v2') {
                        filename = multiline ? 'sample_website_logs_v2_multiline.txt' : 'sample_website_logs_v2.txt';
                    }
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    $('#downloadError').hide();
                })
                .catch(error => {
                    console.error('Download error:', error);
                    $('#downloadError').text(error.error || 'Error downloading file. Please try again.').show();
                })
                .finally(() => {
                    // Restore button state
                    button.prop('disabled', false);
                    const svg = button.find('svg').prop('outerHTML');
                    button.html(svg + ' Download ' + (mode === 'website-v2' ? 
                        (multiline ? 'Website V2 Multiline Sample' : 'Website V2 Sample Log') : 
                        (mode === 'website' ? 'Website Sample Log' : 'Regular Sample Log')));
                });
        });

        $(document).ready(function() {
            $('.filter-header').click(function(e) {
                e.stopPropagation();
                const filterId = $(this).data('filter');
                console.log('Clicked filter:', filterId);
                $(`#${filterId}Filter`).toggleClass('show');
            });

            // Close filter dropdowns when clicking outside
            $(document).click(function(e) {
                if (!$(e.target).closest('.filter-dropdown').length) {
                    $('.filter-content').removeClass('show');
                }
            });
        });

        function updateEventSummary() {
            // Update event count displays
            $('#csvEventsCount').text(currentSummary.csv_events_count || 0);
            $('#logEventsCount').text(currentSummary.log_events_count || 0);
            
            // Calculate missing and extra events
            const csvEvents = new Set(currentSummary.csv_events || []);
            const logEvents = new Set(currentSummary.log_events || []);
            
            const missingEvents = csvEvents.size - new Set([...csvEvents].filter(x => logEvents.has(x))).size;
            const extraEvents = logEvents.size - new Set([...logEvents].filter(x => csvEvents.has(x))).size;
            
            $('#missingEventsCount').text(missingEvents);
            $('#extraEventsCount').text(extraEvents);
        }

        function updateFilters() {
            const eventNames = new Set();
            const expectedTypes = new Set();
            const receivedTypes = new Set();
            const statuses = new Set();
            
            currentResults.forEach(result => {
                if (result.eventName) eventNames.add(result.eventName);
                if (result.expectedType) expectedTypes.add(result.expectedType);
                if (result.receivedType) receivedTypes.add(result.receivedType);
                if (result.validationStatus) statuses.add(result.validationStatus);
            });

            console.log('Available statuses:', Array.from(statuses));

            updateFilterOptions('eventName', eventNames);
            updateFilterOptions('status', statuses);
            updateFilterOptions('expectedType', expectedTypes);
            updateFilterOptions('receivedType', receivedTypes);
        }

        function updateFilterOptions(filterId, values) {
            const container = $(`#${filterId}Options`);
            container.empty();
            
            console.log(`Updating ${filterId} with values:`, Array.from(values));
            
            Array.from(values).sort().forEach(value => {
                if (value) {
                    const checkboxId = `${filterId}_${value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    container.append(`
                        <div class="filter-checkbox">
                            <input type="checkbox" id="${checkboxId}" value="${value}" checked>
                            <label for="${checkboxId}">${value}</label>
                        </div>
                    `);
                }
            });

            // Update select all checkbox
            $(`#${filterId}SelectAll`).prop('checked', true);
        }

        function getSelectedValues(filterId) {
            return $(`#${filterId}Options input:checked`).map(function() {
                return $(this).val();
            }).get();
        }

        function applyFilter(filterId) {
            activeFilters[filterId] = getSelectedValues(filterId);
            applyFilters();
            $(`#${filterId}Filter`).removeClass('show');
        }

        function clearFilter(filterId) {
            $(`#${filterId}Options input`).prop('checked', false);
            $(`#${filterId}SelectAll`).prop('checked', false);
            activeFilters[filterId] = [];
            applyFilters();
            $(`#${filterId}Filter`).removeClass('show');
        }

        function applyFilters() {
            const filters = {
                eventName: activeFilters.eventName,
                validationStatus: activeFilters.status,
                expectedType: activeFilters.expectedType,
                receivedType: activeFilters.receivedType
            };

            // Get the current domain to ensure we're hitting the right server
            const baseUrl = window.location.origin;
            const fullUrl = baseUrl + '/filter';

            console.log('Making filter request to:', fullUrl);

            $.ajax({
                url: fullUrl,
                type: 'POST',
                data: JSON.stringify({
                    results: currentResults,
                    filters: filters,
                    sort_by: currentSort.field,
                    sort_order: currentSort.order
                }),
                contentType: 'application/json',
                success: function(response) {
                    displayResults(response);
                    window.filteredResults = response;
                },
                error: function(xhr) {
                    console.error('Filter error:', xhr);
                    alert('Error applying filters: ' + xhr.responseText);
                }
            });
        }

        // Handle select all checkboxes
        $('[id$="SelectAll"]').change(function() {
            const filterId = this.id.replace('SelectAll', '');
            $(`#${filterId}Options input`).prop('checked', $(this).prop('checked'));
        });

        // Update select all checkbox when individual checkboxes change
        $('.filter-content').on('change', 'input[type="checkbox"]:not([id$="SelectAll"])', function() {
            const filterId = $(this).closest('.filter-content').attr('id').replace('Filter', '');
            const allChecked = $(`#${filterId}Options input:checked`).length === $(`#${filterId}Options input`).length;
            $(`#${filterId}SelectAll`).prop('checked', allChecked);
        });

        $('#clearFilters').click(function() {
            $('.filter-content input[type="checkbox"]').prop('checked', false);
            $('[id$="SelectAll"]').prop('checked', false);
            Object.keys(activeFilters).forEach(key => {
                activeFilters[key] = [];
            });
            applyFilters();
        });

        $('#downloadResults').click(function() {
            // Use filtered results if available, otherwise use all results
            const resultsToDownload = window.filteredResults || currentResults;
            
            // Get the current domain to ensure we're hitting the right server
            const baseUrl = window.location.origin;
            const fullUrl = baseUrl + '/download';
            
            console.log('Making download request to:', fullUrl);
            
            $.ajax({
                url: fullUrl,
                type: 'POST',
                data: JSON.stringify({ results: resultsToDownload }),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'validation_results.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                },
                error: function(xhr) {
                    console.error('Download error:', xhr);
                    alert('Error downloading results: ' + xhr.responseText);
                }
            });
        });

        $('#downloadValidEvents').click(function() {
            // Use filtered results if available, otherwise use all results
            const resultsToDownload = window.filteredResults || currentResults;
            
            // Get the current domain to ensure we're hitting the right server
            const baseUrl = window.location.origin;
            const fullUrl = baseUrl + '/download-valid-events';
            
            console.log('Making download valid events request to:', fullUrl);
            
            $.ajax({
                url: fullUrl,
                type: 'POST',
                data: JSON.stringify({ 
                    results: resultsToDownload,
                    logs_data: window.originalLogs || {}
                }),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'valid_events_report.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                },
                error: function(xhr) {
                    console.error('Download valid events error:', xhr);
                    alert('Error downloading valid events: ' + xhr.responseText);
                }
            });
        });

        function displayResults(results) {
            const tbody = $('#resultsBody');
            tbody.empty();
            
            // Debug log to check results being displayed
            console.log('Displaying results:', results);
            
            results.forEach(result => {
                const statusClass = getStatusClass(result.validationStatus);
                tbody.append(`
                    <tr>
                        <td>${result.eventName}</td>
                        <td>${result.key}</td>
                        <td>${result.value}</td>
                        <td>${result.expectedType}</td>
                        <td>${result.receivedType}</td>
                        <td class="validation-status ${statusClass}">${result.validationStatus}</td>
                    </tr>
                `);
            });
        }

        function getStatusClass(status) {
            if (status === 'Valid') return 'status-valid';
            if (status === 'Invalid/Wrong datatype/value') return 'status-invalid';
            if (status === 'Payload value is Empty') return 'status-empty';
            if (status === 'Extra key present in the log') return 'status-extra';
            if (status === 'Extra event present in logs') return 'status-extra-event';
            if (status === 'Field from extra event') return 'status-extra-field';
            if (status === 'Event name not present in the logs') return 'status-notpresent';
            return '';
        }

        $('.sort-header').click(function() {
            const field = $(this).data('sort');
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            applyFilters();
        });

        $('#eventNameFilter, #statusFilter, #expectedTypeFilter, #receivedTypeFilter').change(applyFilters);
    </script>
</body>
</html>