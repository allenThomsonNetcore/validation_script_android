<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Validation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .table-container { margin-top: 20px; }
        .filter-container { margin: 20px 0; }
        .hidden { display: none; }
        .first-event { color: blue; }
        .null-value { background-color: yellow; }
        .valid-status { color: green; }
        .invalid-status { color: red; }
        .empty-status { color: orange; }
        .not-present { color: darkolivegreen; }
        .extra-key { color: rgb(24, 214, 185); }
        .type-mismatch { background-color: #ffe6e6; }
        .download-section {
            margin: 20px 0;
            text-align: right;
        }
        /* Status color coding */
        .status-valid { background-color: #d4edda !important; color: #155724 !important; }
        .status-invalid { background-color: #f8d7da !important; color: #721c24 !important; }
        .status-empty { background-color: #fff3cd !important; color: #856404 !important; }
        .status-extra { background-color: #d1ecf1 !important; color: #0c5460 !important; }
        .status-notpresent { background-color: #042508 !important; color: #7f7b97 !important; }
        .status-csv { background-color: #e2e3e5 !important; color: #383d41 !important; }
        .validation-status {
            font-weight: bold;
        }
        .status-valid {
            color: #28a745;
        }
        .status-invalid {
            color: #dc3545;
        }
        .status-empty {
            color: #ffc107;
        }
        .status-extra {
            color: #17a2b8;
        }
        .status-similar {
            color: #6f42c1;
            font-style: italic;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .sort-header {
            cursor: pointer;
        }
        .sort-header:hover {
            background-color: #e9ecef;
        }
        .sort-icon {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Payload Validator</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="btn btn-primary" href="https://contact-api-netcore-beta-0-16.onrender.com/" target="_blank">Trigger Activity API</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Event Validation Tool</h2>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV File (Validation Rules)</label>
                        <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                    </div>
                    <div class="mb-3">
                        <label for="txtFile" class="form-label">TXT File (Event Logs)</label>
                        <input type="file" class="form-control" id="txtFile" name="txt_file" accept=".txt" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Validate</button>
                </form>
            </div>
        </div>

        <div class="filter-section" id="filterSection" style="display: none;">
            <h4>Filters</h4>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search all fields...">
                </div>
                <div class="col-md-3 mb-3">
                    <select class="form-control" id="eventNameFilter">
                        <option value="">All Event Names</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <select class="form-control" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Valid">Valid</option>
                        <option value="Invalid/Wrong datatype/value">Invalid</option>
                        <option value="Payload value is Empty">Empty</option>
                        <option value="Extra key present in the log">Extra</option>
                        <option value="Payload not present in the log">Not Present</option>
                        <option value="Similar field found">Similar Field</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <input type="text" class="form-control" id="dateRange" placeholder="Date Range">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <select class="form-control" id="expectedTypeFilter">
                        <option value="">All Expected Types</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <select class="form-control" id="receivedTypeFilter">
                        <option value="">All Received Types</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-secondary" id="clearFilters">Clear Filters</button>
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-success" id="downloadResults">Download Results</button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-striped" id="resultsTable">
                <thead>
                    <tr>
                        <th class="sort-header" data-sort="eventName">Event Name <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="key">Key <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="value">Value <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="expectedType">Expected Type <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="receivedType">Received Type <span class="sort-icon">↕</span></th>
                        <th class="sort-header" data-sort="validationStatus">Status <span class="sort-icon">↕</span></th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        let currentResults = [];
        let currentSort = { field: null, order: 'asc' };

        $('#dateRange').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });

        $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            applyFilters();
        });

        $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
            applyFilters();
        });

        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    currentResults = response;
                    updateFilters();
                    displayResults(response);
                    $('#filterSection').show();
                },
                error: function(xhr) {
                    alert('Error: ' + xhr.responseText);
                }
            });
        });

        function updateFilters() {
            const eventNames = new Set();
            const expectedTypes = new Set();
            const receivedTypes = new Set();
            
            currentResults.forEach(result => {
                eventNames.add(result.eventName);
                expectedTypes.add(result.expectedType);
                receivedTypes.add(result.receivedType);
            });

            updateSelectOptions('#eventNameFilter', eventNames);
            updateSelectOptions('#expectedTypeFilter', expectedTypes);
            updateSelectOptions('#receivedTypeFilter', receivedTypes);
        }

        function updateSelectOptions(selectId, values) {
            const select = $(selectId);
            const currentValue = select.val();
            select.empty().append('<option value="">All</option>');
            values.forEach(value => {
                if (value) {
                    select.append(`<option value="${value}">${value}</option>`);
                }
            });
            select.val(currentValue);
        }

        function applyFilters() {
            const filters = {
                eventName: $('#eventNameFilter').val(),
                validationStatus: $('#statusFilter').val(),
                expectedType: $('#expectedTypeFilter').val(),
                receivedType: $('#receivedTypeFilter').val(),
                search_term: $('#searchInput').val()
            };

            const dateRange = $('#dateRange').val();
            if (dateRange) {
                const [start, end] = dateRange.split(' - ');
                filters.date_range = {
                    start: moment(start, 'MM/DD/YYYY').toISOString(),
                    end: moment(end, 'MM/DD/YYYY').toISOString()
                };
            }

            $.ajax({
                url: '/filter',
                type: 'POST',
                data: JSON.stringify({
                    results: currentResults,
                    filters: filters,
                    sort_by: currentSort.field,
                    sort_order: currentSort.order
                }),
                contentType: 'application/json',
                success: function(response) {
                    displayResults(response);
                }
            });
        }

        function displayResults(results) {
            const tbody = $('#resultsBody');
            tbody.empty();
            
            results.forEach(result => {
                const statusClass = getStatusClass(result.validationStatus);
                const statusText = result.validationStatus.startsWith('Similar field found') 
                    ? `${result.validationStatus} (Expected: ${result.key})`
                    : result.validationStatus;
                
                tbody.append(`
                    <tr>
                        <td>${result.eventName}</td>
                        <td>${result.key}</td>
                        <td>${result.value}</td>
                        <td>${result.expectedType}</td>
                        <td>${result.receivedType}</td>
                        <td class="validation-status ${statusClass}">${statusText}</td>
                    </tr>
                `);
            });
        }

        function getStatusClass(status) {
            if (status === 'Valid') return 'status-valid';
            if (status === 'Invalid/Wrong datatype/value') return 'status-invalid';
            if (status === 'Payload value is Empty') return 'status-empty';
            if (status === 'Extra key present in the log') return 'status-extra';
            if (status.startsWith('Similar field found')) return 'status-similar';
            return '';
        }

        $('.sort-header').click(function() {
            const field = $(this).data('sort');
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            applyFilters();
        });

        $('#eventNameFilter, #statusFilter, #expectedTypeFilter, #receivedTypeFilter').change(applyFilters);
        $('#searchInput').on('input', debounce(applyFilters, 300));

        $('#clearFilters').click(function() {
            $('#eventNameFilter, #statusFilter, #expectedTypeFilter, #receivedTypeFilter').val('');
            $('#searchInput').val('');
            $('#dateRange').val('');
            applyFilters();
        });

        $('#downloadResults').click(function() {
            $.ajax({
                url: '/download',
                type: 'POST',
                data: JSON.stringify({ results: currentResults }),
                contentType: 'application/json',
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'validation_results.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                }
            });
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>